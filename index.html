import React, { useMemo, useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Search,
  MapPin,
  Star,
  Scissors,
  Stethoscope,
  Clock,
  Calendar,
  Phone,
  Upload,
  Download,
  Plus,
  X,
  CheckCircle2,
} from "lucide-react";
import { MapContainer, TileLayer, CircleMarker, Popup } from "react-leaflet";
import "leaflet/dist/leaflet.css";
import Papa from "papaparse";

// ================================
// –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
// ================================

type District =
  | "–î–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π"
  | "–ó–∞–≤–æ–ª–∂—Å–∫–∏–π"
  | "–ö–∏—Ä–æ–≤—Å–∫–∏–π"
  | "–ö—Ä–∞—Å–Ω–æ–ø–µ—Ä–µ–∫–æ–ø—Å–∫–∏–π"
  | "–õ–µ–Ω–∏–Ω—Å–∫–∏–π"
  | "–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π"
  | "–î—Ä—É–≥–æ–π";

type ProviderType = "vet" | "grooming";

type WorkingInterval = { open: string; close: string }; // —Ñ–æ—Ä–º–∞—Ç HH:mm

type WorkingHours = {
  mon?: WorkingInterval[];
  tue?: WorkingInterval[];
  wed?: WorkingInterval[];
  thu?: WorkingInterval[];
  fri?: WorkingInterval[];
  sat?: WorkingInterval[];
  sun?: WorkingInterval[];
};

type Service = {
  name: string;
  priceMin?: number;
  priceMax?: number;
};

type Provider = {
  id: string;
  name: string;
  type: ProviderType;
  district?: District;
  address: string;
  coords?: [number, number]; // [lat, lng]
  phone?: string;
  website?: string;
  rating?: number; // 0..5
  reviewsCount?: number;
  is24x7?: boolean;
  homeVisit?: boolean;
  workingHours?: WorkingHours;
  services: Service[];
  slots?: string[]; // ISO-—Å—Ç—Ä–æ–∫–∏: 2025-08-13T15:30:00
  photos?: string[];
  verifiedDocs?: boolean;
};

// –ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)
const SAMPLE_PROVIDERS: Provider[] = [
  {
    id: "p1",
    name: "–Æ–≤–µ–Ω—Ç–∞ ‚Äî –≤–µ—Ç–∫–ª–∏–Ω–∏–∫–∞ (–ö–∏—Ä–æ–≤—Å–∫–∏–π)",
    type: "vet",
    district: "–ö–∏—Ä–æ–≤—Å–∫–∏–π",
    address: "—É–ª. –ü–æ–±–µ–¥—ã, 12",
    rating: 4.8,
    reviewsCount: 214,
    is24x7: true,
    homeVisit: false,
    verifiedDocs: true,
    services: [
      { name: "–í–∞–∫—Ü–∏–Ω–∞—Ü–∏—è –∫–æ—à–µ–∫", priceMin: 1500, priceMax: 2300 },
      { name: "–£–ó–ò", priceMin: 1800, priceMax: 3200 },
    ],
    workingHours: { mon: [{ open: "00:00", close: "23:59" }] },
    slots: [
      new Date(Date.now() + 60 * 60 * 1000).toISOString(),
      new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString(),
      new Date(Date.now() + 26 * 60 * 60 * 1000).toISOString(),
    ],
    coords: [57.6261, 39.8845],
    phone: "+7 900 000-00-00",
  },
  {
    id: "p2",
    name: "YarGroom ‚Äî —Å–∞–ª–æ–Ω –≥—Ä—É–º–∏–Ω–≥–∞",
    type: "grooming",
    district: "–ó–∞–≤–æ–ª–∂—Å–∫–∏–π",
    address: "–ø—Ä. –ú–∞—à–∏–Ω–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π, 5",
    rating: 4.7,
    reviewsCount: 163,
    is24x7: false,
    homeVisit: true,
    verifiedDocs: true,
    services: [
      { name: "–ö–æ–º–ø–ª–µ–∫—Å –¥–ª—è –º–∞–ª—ã—Ö –ø–æ—Ä–æ–¥", priceMin: 1200, priceMax: 2200 },
      { name: "–°—Ç—Ä–∏–∂–∫–∞ –∫–æ–≥—Ç–µ–π", priceMin: 300, priceMax: 500 },
    ],
    workingHours: {
      mon: [{ open: "09:00", close: "20:00" }],
      tue: [{ open: "09:00", close: "20:00" }],
      wed: [{ open: "09:00", close: "20:00" }],
      thu: [{ open: "09:00", close: "20:00" }],
      fri: [{ open: "09:00", close: "20:00" }],
      sat: [{ open: "10:00", close: "18:00" }],
    },
    slots: [
      new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
      new Date(Date.now() + 5 * 60 * 60 * 1000).toISOString(),
      new Date(Date.now() + 30 * 60 * 60 * 1000).toISOString(),
    ],
    coords: [57.6502, 39.8061],
    phone: "+7 900 111-22-33",
  },
];

// –£—Ç–∏–ª–∏—Ç—ã
const currency = (n?: number) =>
  typeof n === "number"
    ? new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB" }).format(n)
    : "‚Äî";

const districts: District[] = [
  "–î–∑–µ—Ä–∂–∏–Ω—Å–∫–∏–π",
  "–ó–∞–≤–æ–ª–∂—Å–∫–∏–π",
  "–ö–∏—Ä–æ–≤—Å–∫–∏–π",
  "–ö—Ä–∞—Å–Ω–æ–ø–µ—Ä–µ–∫–æ–ø—Å–∫–∏–π",
  "–õ–µ–Ω–∏–Ω—Å–∫–∏–π",
  "–§—Ä—É–Ω–∑–µ–Ω—Å–∫–∏–π",
  "–î—Ä—É–≥–æ–π",
];

function isOpenNow(hours?: WorkingHours, is24x7?: boolean) {
  if (is24x7) return true;
  if (!hours) return false;
  const now = new Date();
  const dayNames: (keyof WorkingHours)[] = [
    "sun",
    "mon",
    "tue",
    "wed",
    "thu",
    "fri",
    "sat",
  ];
  const todayKey = dayNames[now.getDay()];
  const intervals = (hours as any)[todayKey] as WorkingInterval[] | undefined;
  if (!intervals) return false;

  const minsNow = now.getHours() * 60 + now.getMinutes();
  return intervals.some(({ open, close }) => {
    const [oh, om] = open.split(":").map(Number);
    const [ch, cm] = close.split(":").map(Number);
    const start = oh * 60 + om;
    const end = ch * 60 + cm;
    return minsNow >= start && minsNow <= end;
  });
}

function nearestSlotISO(slots?: string[]) {
  if (!slots || !slots.length) return undefined;
  const upcoming = slots
    .map((s) => new Date(s))
    .filter((d) => d.getTime() > Date.now())
    .sort((a, b) => a.getTime() - b.getTime());
  return upcoming[0]?.toISOString();
}

function formatDateTime(iso?: string) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  return d.toLocaleString("ru-RU", {
    day: "2-digit",
    month: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

// ================================
// –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
// ================================
export default function VetGroomMarketplaceTemplate() {
  const [providers, setProviders] = useState<Provider[]>(SAMPLE_PROVIDERS);
  const [query, setQuery] = useState("");
  const [type, setType] = useState<ProviderType | "all">("all");
  const [districtFilter, setDistrictFilter] = useState<District | "all">("all");
  const [openNow, setOpenNow] = useState(false);
  const [is247, setIs247] = useState(false);
  const [homeVisit, setHomeVisit] = useState(false);
  const [sortBy, setSortBy] = useState<"slot" | "rating">("slot");
  const [showAdd, setShowAdd] = useState(false);
  const [bookingProvider, setBookingProvider] = useState<Provider | null>(null);

  // –ú–∞—Ä–∫–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ –∏ —Ü–µ–Ω—Ç—Ä (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ coords)
  const markers = useMemo(
    () =>
      providers.filter(
        (p) =>
          Array.isArray(p.coords) &&
          typeof p.coords[0] === "number" &&
          typeof p.coords[1] === "number"
      ),
    [providers]
  );

  const center = useMemo<[number, number]>(() => {
    if (!markers.length) return [57.6261, 39.8845]; // –Ø—Ä–æ—Å–ª–∞–≤–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const avgLat = markers.reduce((s, p) => s + (p.coords![0] || 0), 0) / markers.length;
    const avgLng = markers.reduce((s, p) => s + (p.coords![1] || 0), 0) / markers.length;
    return [avgLat, avgLng];
  }, [markers]);

  // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
  const filtered = useMemo(() => {
    let list = providers.filter((p) => {
      if (type !== "all" && p.type !== type) return false;
      if (districtFilter !== "all" && p.district !== districtFilter) return false;
      if (openNow && !isOpenNow(p.workingHours, p.is24x7)) return false;
      if (is247 && !p.is24x7) return false;
      if (homeVisit && !p.homeVisit) return false;
      if (query.trim()) {
        const q = query.toLowerCase();
        const inText =
          p.name.toLowerCase().includes(q) ||
          p.address.toLowerCase().includes(q) ||
          p.services.some((s) => s.name.toLowerCase().includes(q));
        if (!inText) return false;
      }
      return true;
    });

    list = list.sort((a, b) => {
      if (sortBy === "rating") return (b.rating || 0) - (a.rating || 0);
      const as = nearestSlotISO(a.slots)?.valueOf() ?? Infinity;
      const bs = nearestSlotISO(b.slots)?.valueOf() ?? Infinity;
      return as - bs;
    });
    return list;
  }, [providers, query, type, districtFilter, openNow, is247, homeVisit, sortBy]);

  // –ò–º–ø–æ—Ä—Ç JSON
  function importJSON(file: File) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result));
        if (!Array.isArray(data)) throw new Error("–û–∂–∏–¥–∞–ª—Å—è –º–∞—Å—Å–∏–≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤");
        setProviders(data);
      } catch (e: any) {
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + e.message);
      }
    };
    reader.readAsText(file);
  }

  // –ò–º–ø–æ—Ä—Ç CSV (Papaparse)
  function importCSV(file: File) {
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const text = String(reader.result || "");
        const res: any = (Papa as any).parse(text, { header: true, skipEmptyLines: true });
        const rows: any[] = res?.data || [];
        const parsed: Provider[] = rows.map((row: any, idx: number) => {
          const coords: [number, number] | undefined =
            typeof row.coords === "string" && row.coords.includes(",")
              ? (row.coords.split(",").map((v: string) => parseFloat(v.trim())) as [number, number])
              : undefined;

          const services: Service[] =
            typeof row.services === "string" && row.services.length
              ? row.services.split(";").map((t: string) => {
                  const [namePart, pricePart] = t.split(":").map((s) => s?.trim());
                  const clean = (s: string) => s.replace(/[^0-9-]/g, "");
                  let priceMin: number | undefined = undefined;
                  let priceMax: number | undefined = undefined;
                  if (pricePart) {
                    if (pricePart.includes("-")) {
                      const [a, b] = clean(pricePart).split("-").map((x) => Number(x));
                      priceMin = isFinite(a) ? a : undefined;
                      priceMax = isFinite(b) ? b : undefined;
                    } else {
                      const v = Number(clean(pricePart));
                      priceMin = isFinite(v) ? v : undefined;
                    }
                  }
                  return { name: namePart || "–£—Å–ª—É–≥–∞", priceMin, priceMax } as Service;
                })
              : [];

          const slots: string[] =
            typeof row.slots === "string" && row.slots.length
              ? row.slots
                  .split("|")
                  .map((s: string) => new Date(s).toISOString())
                  .filter((s: string) => !isNaN(new Date(s).getTime()))
              : [];

          return {
            id: row.id || `csv_${idx}_${Math.random().toString(36).slice(2)}`,
            name: row.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
            type: String(row.type).toLowerCase().includes("groom") ? "grooming" : "vet",
            district: (row.district as District) || "–î—Ä—É–≥–æ–π",
            address: row.address || "",
            phone: row.phone || "",
            is24x7: row.is24x7 === "1" || String(row.is24x7).toLowerCase() === "true",
            homeVisit: row.homeVisit === "1" || String(row.homeVisit).toLowerCase() === "true",
            verifiedDocs: row.verifiedDocs === "1" || String(row.verifiedDocs).toLowerCase() === "true",
            rating: row.rating ? Number(row.rating) : undefined,
            reviewsCount: row.reviewsCount ? Number(row.reviewsCount) : undefined,
            services,
            slots,
            coords,
            workingHours: {},
          } as Provider;
        });
        setProviders(parsed);
      } catch (e: any) {
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV: " + e.message);
      }
    };
    reader.readAsText(file);
  }

  // –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω CSV
  function downloadCSVTemplate() {
    const header = [
      "id","name","type","district","address","phone",
      "is24x7","homeVisit","verifiedDocs","rating","reviewsCount",
      "coords","services","slots"
    ].join(",");
    const row1 = [
      "p100","–Æ–≤–µ–Ω—Ç–∞ ‚Äî –≤–µ—Ç–∫–ª–∏–Ω–∏–∫–∞","vet","–ö–∏—Ä–æ–≤—Å–∫–∏–π","—É–ª. –ü–æ–±–µ–¥—ã, 12","+7 900 000-00-00",
      "1","0","1","4.8","214",
      "\"57.6261,39.8845\"",
      "\"–í–∞–∫—Ü–∏–Ω–∞—Ü–∏—è –∫–æ—à–µ–∫:1500-2300; –£–ó–ò:1800-3200\"",
      "\"2025-08-14T10:30:00|2025-08-14T12:00:00\""
    ].join(",");
    const row2 = [
      "p101","YarGroom ‚Äî —Å–∞–ª–æ–Ω –≥—Ä—É–º–∏–Ω–≥–∞","grooming","–ó–∞–≤–æ–ª–∂—Å–∫–∏–π","–ø—Ä. –ú–∞—à–∏–Ω–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª–µ–π, 5","+7 900 111-22-33",
      "0","1","1","4.7","163",
      "\"57.6502,39.8061\"",
      "\"–ö–æ–º–ø–ª–µ–∫—Å –º–∞–ª—ã–µ –ø–æ—Ä–æ–¥—ã:1200-2200; –°—Ç—Ä–∏–∂–∫–∞ –∫–æ–≥—Ç–µ–π:300-500\"",
      "\"2025-08-14T11:00:00|2025-08-14T15:30:00\""
    ].join(",");
    const csv = [header, row1, row2].join("\n"); // —Ñ–∏–∫—Å
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "providers_template.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // –≠–∫—Å–ø–æ—Ä—Ç JSON
  function exportJSON() {
    const blob = new Blob([JSON.stringify(providers, null, 2)], {
      type: "application/json;charset=utf-8",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "providers.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="min-h-screen bg-neutral-50">
      {/* Header */}
      <header className="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
        <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
          <div className="flex items-center gap-2">
            <div className="size-9 rounded-2xl bg-black text-white grid place-items-center">
              <Stethoscope className="size-5" />
            </div>
            <h1 className="text-xl sm:text-2xl font-semibold tracking-tight">
              –ü–µ—Ç-—Å–µ—Ä–≤–∏—Å –Ø—Ä–æ—Å–ª–∞–≤–ª—å ‚Äî –í–µ—Ç & –ì—Ä—É–º–∏–Ω–≥
            </h1>
          </div>
          <div className="ml-auto flex items-center gap-2">
            <label className="px-3 py-2 rounded-xl border bg-white cursor-pointer flex items-center gap-2">
              <Upload className="size-4" /> –ò–º–ø–æ—Ä—Ç JSON
              <input
                type="file"
                accept="application/json"
                className="hidden"
                onChange={(e) => e.target.files && importJSON(e.target.files[0])}
              />
            </label>
            <label className="px-3 py-2 rounded-xl border bg-white cursor-pointer flex items-center gap-2">
              <Upload className="size-4" /> –ò–º–ø–æ—Ä—Ç CSV
              <input
                type="file"
                accept=".csv,text/csv"
                className="hidden"
                onChange={(e) => e.target.files && importCSV(e.target.files[0])}
              />
            </label>
            <button
              onClick={exportJSON}
              className="px-3 py-2 rounded-xl border bg-white flex items-center gap-2 hover:shadow"
            >
              <Download className="size-4" /> –≠–∫—Å–ø–æ—Ä—Ç
            </button>
            <button
              onClick={downloadCSVTemplate}
              className="px-3 py-2 rounded-xl border bg-white flex items-center gap-2 hover:shadow"
            >
              <Download className="size-4" /> –®–∞–±–ª–æ–Ω CSV
            </button>
            <button
              onClick={() => setShowAdd(true)}
              className="px-3 py-2 rounded-xl bg-black text-white rounded-2xl flex items-center gap-2 hover:opacity-90"
            >
              <Plus className="size-4" /> –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            </button>
          </div>
        </div>
      </header>

      {/* Toolbar */}
      <div className="mx-auto max-w-7xl px-4 py-4 grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div className="lg:col-span-1">
          <div className="bg-white rounded-2xl shadow-sm border p-4 space-y-4">
            <div>
              <label className="text-sm text-neutral-600">–ü–æ–∏—Å–∫</label>
              <div className="mt-1 relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-neutral-400" />
                <input
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="–£—Å–ª—É–≥–∞, –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ"
                  className="w-full pl-10 pr-3 py-2 rounded-xl border focus:outline-none focus:ring-2 focus:ring-black/20"
                />
              </div>
            </div>

            <div>
              <label className="text-sm text-neutral-600">–¢–∏–ø</label>
              <div className="mt-2 grid grid-cols-3 gap-2">
                <button
                  onClick={() => setType("all")}
                  className={`px-3 py-2 rounded-xl border ${
                    type === "all" ? "bg-black text-white" : "bg-white"
                  }`}
                >
                  –í—Å–µ
                </button>
                <button
                  onClick={() => setType("vet")}
                  className={`px-3 py-2 rounded-xl border flex items-center justify-center gap-2 ${
                    type === "vet" ? "bg-black text-white" : "bg-white"
                  }`}
                >
                  <Stethoscope className="size-4" /> –í–µ—Ç
                </button>
                <button
                  onClick={() => setType("grooming")}
                  className={`px-3 py-2 rounded-xl border flex items-center justify-center gap-2 ${
                    type === "grooming" ? "bg-black text-white" : "bg-white"
                  }`}
                >
                  <Scissors className="size-4" /> –ì—Ä—É–º
                </button>
              </div>
            </div>

            <div>
              <label className="text-sm text-neutral-600">–†–∞–π–æ–Ω</label>
              <select
                value={districtFilter}
                onChange={(e) => setDistrictFilter(e.target.value as any)}
                className="mt-1 w-full px-3 py-2 rounded-xl border bg-white"
              >
                <option value="all">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
                {districts.map((d) => (
                  <option key={d} value={d}>
                    {d}
                  </option>
                ))}
              </select>
            </div>

            <div className="grid grid-cols-2 gap-2">
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={openNow}
                  onChange={(e) => setOpenNow(e.target.checked)}
                />
                –û—Ç–∫—Ä—ã—Ç–æ —Å–µ–π—á–∞—Å
              </label>
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={is247}
                  onChange={(e) => setIs247(e.target.checked)}
                />
                24/7
              </label>
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={homeVisit}
                  onChange={(e) => setHomeVisit(e.target.checked)}
                />
                –í—ã–µ–∑–¥ –Ω–∞ –¥–æ–º
              </label>
              <div>
                <label className="text-sm text-neutral-600">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value as any)}
                  className="mt-1 w-full px-3 py-2 rounded-xl border bg-white"
                >
                  <option value="slot">–ë–ª–∏–∂–∞–π—à–∏–π —Å–ª–æ—Ç</option>
                  <option value="rating">–†–µ–π—Ç–∏–Ω–≥</option>
                </select>
              </div>
            </div>

            <div className="rounded-xl bg-neutral-50 border p-3 text-xs text-neutral-600">
              <b>–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?</b>
              <ul className="list-disc pl-5 mt-1 space-y-1">
                <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ò–º–ø–æ—Ä—Ç JSON¬ª –∏–ª–∏ ¬´–ò–º–ø–æ—Ä—Ç CSV¬ª –≤–≤–µ—Ä—Ö—É.</li>
                <li>CSV: —Å—Ç–æ–ª–±—Ü—ã <code>id,name,type,district,address,phone,is24x7,homeVisit,verifiedDocs,rating,reviewsCount,coords,services,slots</code>.</li>
                <li><code>coords</code> = "lat,lng"; <code>services</code> = "–ù–∞–∑–≤–∞–Ω–∏–µ:1000-2000; –î—Ä—É–≥–∞—è:500-700"; <code>slots</code> = ISO —á–µ—Ä–µ–∑ ¬´|¬ª.</li>
                <li>–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ ¬´–î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è¬ª.</li>
              </ul>
            </div>
          </div>
        </div>

        {/* Results + Map */}
        <div className="lg:col-span-3 space-y-4">
          <div className="h-72 rounded-2xl overflow-hidden border shadow-sm bg-white">
            <MapContainer center={center as any} zoom={12} style={{ height: "100%", width: "100%" }}>
              <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" attribution="&copy; OpenStreetMap" />
              {markers.map((p) =>
                p.coords ? (
                  <CircleMarker key={p.id} center={p.coords as any} radius={8}>
                    <Popup>
                      <div className="text-sm">
                        <div className="font-semibold">{p.name}</div>
                        <div className="text-neutral-600">{p.address}</div>
                        <div className="mt-1">{p.services?.[0]?.name || "–£—Å–ª—É–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã"}</div>
                        <button className="mt-2 px-2 py-1 rounded-lg border" onClick={() => setBookingProvider(p)}>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
                      </div>
                    </Popup>
                  </CircleMarker>
                ) : null
              )}
            </MapContainer>
          </div>

          <div className="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
            <AnimatePresence>
              {filtered.map((p) => {
                const open = isOpenNow(p.workingHours, p.is24x7);
                const next = nearestSlotISO(p.slots);
                return (
                  <motion.div
                    key={p.id}
                    layout
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -10 }}
                    className="bg-white rounded-2xl border shadow-sm overflow-hidden flex flex-col"
                  >
                    <div className="h-28 bg-gradient-to-br from-neutral-50 to-white grid grid-cols-3 gap-1 p-2">
                      {new Array(3).fill(0).map((_, i) => (
                        <div key={i} className="rounded-xl bg-neutral-100/70 border" />
                      ))}
                    </div>
                    <div className="p-4 flex-1 flex flex-col gap-3">
                      <div className="flex items-start justify-between gap-2">
                        <div>
                          <h3 className="font-semibold leading-tight">{p.name}</h3>
                          <div className="text-xs text-neutral-500 flex items-center gap-1 mt-1">
                            <MapPin className="size-3" /> {p.district || "‚Äî"} ¬∑ {p.address}
                          </div>
                        </div>
                        <div className="flex items-center gap-1 text-amber-500">
                          <Star className="size-4" />
                          <span className="text-sm font-medium">{p.rating?.toFixed(1) || "‚Äî"}</span>
                          <span className="text-xs text-neutral-400">({p.reviewsCount || 0})</span>
                        </div>
                      </div>

                      <div className="flex flex-wrap gap-2 text-xs">
                        {p.services.slice(0, 3).map((s, idx) => (
                          <span key={idx} className="px-2 py-1 rounded-full border bg-neutral-50">
                            {s.name} ¬∑ {currency(s.priceMin)}
                            {s.priceMax ? `‚Äì${currency(s.priceMax)}` : ""}
                          </span>
                        ))}
                        {p.services.length > 3 && (
                          <span className="px-2 py-1 rounded-full border bg-neutral-50">
                            +{p.services.length - 3} —É—Å–ª—É–≥
                          </span>
                        )}
                      </div>

                      <div className="flex items-center gap-2 text-xs">
                        {p.type === "vet" ? (
                          <span className="px-2 py-1 rounded-full border flex items-center gap-1">
                            <Stethoscope className="size-3" /> –í–µ—Ç–∫–ª–∏–Ω–∏–∫–∞
                          </span>
                        ) : (
                          <span className="px-2 py-1 rounded-full border flex items-center gap-1">
                            <Scissors className="size-3" /> –ì—Ä—É–º–∏–Ω–≥
                          </span>
                        )}
                        {p.is24x7 && (
                          <span className="px-2 py-1 rounded-full border flex items-center gap-1">
                            <Clock className="size-3" /> 24/7
                          </span>
                        )}
                        {p.homeVisit && (
                          <span className="px-2 py-1 rounded-full border flex items-center gap-1">
                            üöó –í—ã–µ–∑–¥
                          </span>
                        )}
                        {p.verifiedDocs && (
                          <span className="px-2 py-1 rounded-full border flex items-center gap-1 text-emerald-600">
                            <CheckCircle2 className="size-3" /> –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ
                          </span>
                        )}
                      </div>

                      <div className="mt-auto">
                        <div className="text-xs text-neutral-500 flex items-center gap-2">
                          <Calendar className="size-3" /> –ë–ª–∏–∂–∞–π—à–µ–µ: {formatDateTime(next)}
                        </div>
                        <div className="flex gap-2 mt-2">
                          <button
                            onClick={() => setBookingProvider(p)}
                            className="px-3 py-2 rounded-xl bg-black text-white hover:opacity-90"
                          >
                            –ó–∞–ø–∏—Å–∞—Ç—å—Å—è
                          </button>
                          {p.phone && (
                            <a
                              href={`tel:${p.phone.replace(/\s|$begin:math:text$|$end:math:text$|-/g, "")}`}
                              className="px-3 py-2 rounded-xl border bg-white flex items-center gap-2"
                            >
                              <Phone className="size-4" /> –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                            </a>
                          )}
                        </div>
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </AnimatePresence>
          </div>

          {filtered.length === 0 && (
            <div className="text-center text-neutral-500 text-sm py-10">
              –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ.
            </div>
          )}
        </div>
      </div>

      {/* –ú–æ–¥–∞–ª–∫–∞: –î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */}
      <AnimatePresence>
        {showAdd && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 bg-black/40 grid place-items-center p-4"
          >
            <motion.div
              initial={{ scale: 0.98, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.98, opacity: 0 }}
              className="bg-white max-w-2xl w-full rounded-2xl p-4 border shadow-lg"
            >
              <div className="flex items-center justify-between">
                <h3 className="font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h3>
                <button onClick={() => setShowAdd(false)} className="p-2">
                  <X className="size-5" />
                </button>
              </div>
              <SimpleAddForm
                onAdd={(p) => {
                  setProviders((prev) => [...prev, p]);
                  setShowAdd(false);
                }}
              />
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* –ú–æ–¥–∞–ª–∫–∞: –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–µ–º–æ) */}
      <AnimatePresence>
        {bookingProvider && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 bg-black/40 grid place-items-center p-4"
          >
            <motion.div
              initial={{ scale: 0.98, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.98, opacity: 0 }}
              className="bg-white max-w-lg w-full rounded-2xl p-4 border shadow-lg"
            >
              <div className="flex items-center justify-between">
                <h3 className="font-semibold">–ó–∞–ø–∏—Å—å ‚Äî {bookingProvider.name}</h3>
                <button onClick={() => setBookingProvider(null)} className="p-2">
                  <X className="size-5" />
                </button>
              </div>
              <p className="text-sm text-neutral-600 mt-1">
                –í—ã–±–µ—Ä–∏—Ç–µ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. (–î–µ–º–æ ‚Äî –±–µ–∑ –æ–ø–ª–∞—Ç—ã.)
              </p>
              <div className="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
                {(bookingProvider.slots || []).slice(0, 9).map((s) => (
                  <button
                    key={s}
                    onClick={() => {
                      alert(
                        `–ë—Ä–æ–Ω—å —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ ${formatDateTime(s)} (–¥–µ–º–æ). –ü–æ–¥–∫–ª—é—á–∏—Ç–µ API –∑–∞–ø–∏—Å–∏/–æ–ø–ª–∞—Ç—É.`
                      );
                      setBookingProvider(null);
                    }}
                    className="px-3 py-2 rounded-xl border hover:bg-neutral-50"
                  >
                    {formatDateTime(s)}
                  </button>
                ))}
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      <footer className="py-10 text-center text-xs text-neutral-500">
        –®–∞–±–ª–æ–Ω –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞ (React + Tailwind). –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ JSON, –ø—Ä–∏
        –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–∞—Ä—Ç—ã –∏ –æ–ø–ª–∞—Ç—É.
      </footer>
    </div>
  );
}

// –ü—Ä–æ—Å—Ç–µ–π—à–∞—è —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–º–∏–Ω–∏–º—É–º –ø–æ–ª–µ–π)
function SimpleAddForm({ onAdd }: { onAdd: (p: Provider) => void }) {
  const [name, setName] = useState("");
  const [type, setType] = useState<ProviderType>("vet");
  const [district, setDistrict] = useState<District>("–ö–∏—Ä–æ–≤—Å–∫–∏–π");
  const [address, setAddress] = useState("");
  const [phone, setPhone] = useState("");
  const [is247, setIs247] = useState(false);
  const [homeVisit, setHomeVisit] = useState(false);

  return (
    <form
      className="mt-3 grid grid-cols-2 gap-3"
      onSubmit={(e) => {
        e.preventDefault();
        const newProvider: Provider = {
          id: "p_" + Math.random().toString(36).slice(2),
          name,
          type,
          district,
          address,
          phone,
          is24x7: is247,
          homeVisit,
          services: [],
          workingHours: {},
          slots: [],
        };
        onAdd(newProvider);
      }}
    >
      <div className="col-span-2 grid grid-cols-2 gap-3">
        <div>
          <label className="text-sm text-neutral-600">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input
            required
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="mt-1 w-full px-3 py-2 rounded-xl border"
          />
        </div>
        <div>
          <label className="text-sm text-neutral-600">–¢–∏–ø</label>
          <select
            value={type}
            onChange={(e) => setType(e.target.value as ProviderType)}
            className="mt-1 w-full px-3 py-2 rounded-xl border bg-white"
          >
            <option value="vet">–í–µ—Ç–∫–ª–∏–Ω–∏–∫–∞</option>
            <option value="grooming">–ì—Ä—É–º–∏–Ω–≥</option>
          </select>
        </div>
      </div>

      <div>
        <label className="text-sm text-neutral-600">–†–∞–π–æ–Ω</label>
        <select
          value={district}
          onChange={(e) => setDistrict(e.target.value as District)}
          className="mt-1 w-full px-3 py-2 rounded-xl border bg-white"
        >
          {districts.map((d) => (
            <option key={d} value={d}>
              {d}
            </option>
          ))}
        </select>
      </div>

      <div>
        <label className="text-sm text-neutral-600">–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input
          value={phone}
          onChange={(e) => setPhone(e.target.value)}
          className="mt-1 w-full px-3 py-2 rounded-xl border"
        />
      </div>

      <div className="col-span-2">
        <label className="text-sm text-neutral-600">–ê–¥—Ä–µ—Å</label>
        <input
          value={address}
          onChange={(e) => setAddress(e.target.value)}
          className="mt-1 w-full px-3 py-2 rounded-xl border"
        />
      </div>

      <div className="col-span-2 flex items-center gap-4">
        <label className="flex items-center gap-2 text-sm">
          <input
            type="checkbox"
            checked={is247}
            onChange={(e) => setIs247(e.target.checked)}
          />
          24/7
        </label>
        <label className="flex items-center gap-2 text-sm">
          <input
            type="checkbox"
            checked={homeVisit}
            onChange={(e) => setHomeVisit(e.target.checked)}
          />
          –í—ã–µ–∑–¥ –Ω–∞ –¥–æ–º
        </label>
      </div>

      <div className="col-span-2 flex justify-end gap-2 mt-2">
        <button
          type="button"
          onClick={() => { setName(""); setAddress(""); setPhone(""); }}
          className="px-3 py-2 rounded-xl border"
        >
          –û—á–∏—Å—Ç–∏—Ç—å
        </button>
        <button type="submit" className="px-3 py-2 rounded-xl bg-black text-white">
          –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </div>
    </form>
  );
}
